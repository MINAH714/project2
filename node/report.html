<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Winterì˜ ì£¼ê°„ ê°ì • ê·¸ë˜í”„</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #e0f7fa; margin: 0; flex-direction: column; color: #333; }
        .chart-container { width: 90%; max-width: 800px; background-color: white; padding: 25px; border-radius: 12px; box-shadow: 0 6px 15px rgba(0,0,0,0.15); margin-bottom: 20px; }
        h1 { color: #00796b; margin-bottom: 25px; font-size: 2em; }
        #emotionDetails { margin-top: 20px; padding: 20px; border: 1px solid #b2ebf2; border-radius: 8px; background-color: #e0f2f7; font-size: 1.1em; white-space: pre-line; line-height: 1.6; color: #006064; text-align: left; max-width: 700px; width: 90%; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .emotion-color-box { display: inline-block; width: 18px; height: 18px; margin-right: 8px; border-radius: 4px; vertical-align: middle; }
        .legend-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-top: 20px; padding: 10px; background-color: #f1f8e9; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .legend-item { display: flex; align-items: center; font-size: 1.1em; color: #424242; }
    </style>
</head>
<body>
    <h1>Winterì˜ ì£¼ê°„ ê°ì • ê·¸ë˜í”„</h1>
    <div class="chart-container">
        <canvas id="emotionChart"></canvas>
    </div>
    <div id="emotionDetails">
        ê·¸ë˜í”„ì˜ ë§‰ëŒ€ë¥¼ í´ë¦­í•˜ë©´ í•´ë‹¹ ë‚ ì§œì˜ ê°ì • ìƒì„¸ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
    </div>

    <script>
        const emotionEmoji = {
            "ë¶„ë…¸": "ğŸ˜¡",
            "ë†€ëŒ": "ğŸ˜®",
            "ìŠ¬í””": "ğŸ¥²",
            "ê¸°ì¨": "ğŸ˜„",
            "ë‘ë ¤ì›€": "ğŸ˜Ÿ"
        };

        const emotionColors = {
            "ê¸°ì¨": "rgba(75, 192, 192, 0.7)",    // ì²­ë¡ìƒ‰
            "ìŠ¬í””": "rgba(54, 162, 235, 0.7)",    // íŒŒë€ìƒ‰
            "ë¶„ë…¸": "rgba(255, 99, 132, 0.7)",    // ë¹¨ê°„ìƒ‰
            "ë†€ëŒ": "rgba(255, 206, 86, 0.7)",    // ë…¸ë€ìƒ‰
            "ë‘ë ¤ì›€": "rgba(153, 102, 255, 0.7)", // ë³´ë¼ìƒ‰
            "ê¸°íƒ€": "rgba(201, 203, 207, 0.7)"   // íšŒìƒ‰
        };

        async function fetchEmotionData() {
            try {
                // main.jsë¥¼ í†µí•´ ê°™ì€ ê²½ë¡œì˜ Winter_female_18.json íŒŒì¼ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
                const response = await fetch('/Winter_female_18.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const jsonData = await response.json();
                return jsonData;
            } catch (error) {
                console.error("JSON íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:", error);
                document.getElementById('emotionDetails').innerText = "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ê³ , íŒŒì¼ ê²½ë¡œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.";
                return null;
            }
        }

        function processEmotionData(jsonData, targetPerson = "Winter") {
            const dailyEmotions = {};

            jsonData.forEach(entry => {
                if (entry.person_name === targetPerson) {
                    const date = entry.timestamp; // ì´ë¯¸ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ê°€ì •

                    if (!dailyEmotions[date]) {
                        dailyEmotions[date] = {
                            counts: {},
                            total: 0
                        };
                    }

                    entry.conversation.forEach(chat => {
                        if (chat.speaker === targetPerson && chat.emotions) {
                            chat.emotions.forEach(emotion => {
                                dailyEmotions[date].counts[emotion] = (dailyEmotions[date].counts[emotion] || 0) + 1;
                                dailyEmotions[date].total += 1;
                            });
                        }
                    });
                }
            });

            const processedData = {};
            // ë‚ ì§œë¥¼ ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ 7ê°œë§Œ ì„ íƒ
            const sortedDates = Object.keys(dailyEmotions).sort();
            
            // ìµœê·¼ 7ì¼ ë°ì´í„°ë§Œ ì‚¬ìš©
            const recent7Days = sortedDates.slice(-7); 

            recent7Days.forEach(date => {
                const emotionsCount = dailyEmotions[date] ? dailyEmotions[date].counts : {};
                if (Object.keys(emotionsCount).length === 0) {
                     processedData[date] = {
                        main_emotion: "ë°ì´í„° ì—†ìŒ",
                        main_emotion_count: 0,
                        all_emotions: {}
                    };
                    return;
                }

                let mostCommonEmotion = "ë°ì´í„° ì—†ìŒ";
                let maxCount = 0;

                for (const emotion in emotionsCount) {
                    if (emotionsCount[emotion] > maxCount) {
                        maxCount = emotionsCount[emotion];
                        mostCommonEmotion = emotion;
                    }
                }
                
                processedData[date] = {
                    main_emotion: mostCommonEmotion,
                    main_emotion_count: maxCount,
                    all_emotions: emotionsCount
                };
            });
            return processedData;
        }

        async function createChart() {
            const jsonData = await fetchEmotionData();
            if (!jsonData) return;

            const processedData = processEmotionData(jsonData, "Winter");

            // ë°ì´í„° ì •ë ¬ (ë‚ ì§œ ìˆœì„œëŒ€ë¡œ)
            const dates = Object.keys(processedData).sort();
            const mainEmotionCounts = dates.map(date => processedData[date].main_emotion_count);
            const mainEmotions = dates.map(date => processedData[date].main_emotion);

            // ê° ë‚ ì§œì˜ ì£¼ ê°ì •ì— ë”°ë¼ ë§‰ëŒ€ ìƒ‰ìƒ ì„¤ì •
            const barColors = dates.map(date => emotionColors[processedData[date].main_emotion] || emotionColors["ê¸°íƒ€"]);

            const ctx = document.getElementById('emotionChart').getContext('2d');
            const emotionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dates.map(date => {
                        const d = new Date(date);
                        // 2025ë…„ 6ì›” 5ì¼ í˜•ì‹
                        return `${d.getFullYear()}ë…„ ${d.getMonth() + 1}ì›” ${d.getDate()}ì¼`;
                    }),
                    datasets: [{
                        label: 'ì£¼ ê°ì • ê°¯ìˆ˜',
                        data: mainEmotionCounts,
                        backgroundColor: barColors,
                        borderColor: barColors.map(color => color.replace('0.7', '1')), // í…Œë‘ë¦¬ ìƒ‰ìƒì€ ë¶ˆíˆ¬ëª…í•˜ê²Œ
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Winter', // ê·¸ë˜í”„ ì œëª©
                            font: { size: 24, weight: 'bold', family: 'Segoe UI' },
                            color: '#00796b'
                        },
                        legend: {
                            display: false // ì£¼ ê°ì •ë³„ ìƒ‰ìƒì€ ì•„ë˜ ë²”ë¡€ì—ì„œ ì§ì ‘ ì •ì˜
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'ë‚ ì§œ',
                                font: { size: 16, weight: 'bold' },
                                color: '#555'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: { size: 14 }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'ì£¼ ê°ì • ê°¯ìˆ˜',
                                font: { size: 16, weight: 'bold' },
                                color: '#555'
                            },
                            ticks: {
                                stepSize: 1, // ê°¯ìˆ˜ëŠ” ì •ìˆ˜ë¡œ í‘œì‹œ
                                font: { size: 14 }
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const clickedDateRaw = dates[index]; // YYYY-MM-DD í˜•ì‹
                            const dailyData = processedData[clickedDateRaw];
                            
                            let detailsHtml = ``;
                            if (dailyData && dailyData.all_emotions) {
                                const formattedDate = new Date(clickedDateRaw).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
                                detailsHtml += `${formattedDate}\n`;

                                // ê°ì • ê°¯ìˆ˜ë¥¼ ë‚´ë¦¼ì°¨ìˆœìœ¼ë¡œ ì •ë ¬
                                const sortedEmotions = Object.entries(dailyData.all_emotions).sort(([,countA], [,countB]) => countB - countA);

                                sortedEmotions.forEach(([emotion, count]) => {
                                    detailsHtml += `${emotion}${emotionEmoji[emotion] || ''}: ${count}íšŒ\n`;
                                });
                            } else {
                                detailsHtml += `í•´ë‹¹ ë‚ ì§œì˜ ìƒì„¸ ê°ì • ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`;
                            }
                            document.getElementById('emotionDetails').innerText = detailsHtml;
                        }
                    }
                }
            });

            // ë²”ë¡€ ìƒì„± (HTMLë¡œ ì§ì ‘)
            const legendContainer = document.createElement('div');
            legendContainer.className = 'legend-container';
            
            // ëª¨ë“  ê°€ëŠ¥í•œ ê°ì • ëª©ë¡ì„ ì‚¬ìš©í•˜ì—¬ ë²”ë¡€ ìƒì„±
            const allPossibleEmotions = ["ê¸°ì¨", "ìŠ¬í””", "ë¶„ë…¸", "ë†€ëŒ", "ë‘ë ¤ì›€"];
            allPossibleEmotions.forEach(emotion => {
                const legendItem = document.createElement('span');
                legendItem.className = 'legend-item';
                const colorBox = document.createElement('span');
                colorBox.className = 'emotion-color-box';
                colorBox.style.backgroundColor = emotionColors[emotion].replace('0.7', '1');
                legendItem.appendChild(colorBox);
                legendItem.appendChild(document.createTextNode(emotion));
                legendContainer.appendChild(legendItem);
            });
            document.querySelector('.chart-container').insertAdjacentElement('afterend', legendContainer);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì°¨íŠ¸ ìƒì„± í•¨ìˆ˜ í˜¸ì¶œ
        createChart();

    </script>
</body>
</html>